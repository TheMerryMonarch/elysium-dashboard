<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elysium Tank Dashboard</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <div id="title">Elysium Tank</div>
  <button class="lang-toggle" onclick="toggleLanguage()">日本語</button>

  <div id="shrimp-census-tile">
    <div class="shrimp-title">Shrimp Census</div>
    <div class="shrimp-count">94</div>
    <div class="shrimp-subtext">as of 10/1/25</div>
  </div>
</header>

<main>
  <div class="sensor-grid">

    <!-- Temperature -->
    <section class="sensor-panel">
      <div class="sensor-card">
        <div class="sensor-name" id="temp-label">Temperature</div>
        <div id="temp-value" class="sensor-value">--</div>
        <div class="sensor-unit" id="temp-unit">°F</div>
        <div id="last-updated" class="sensor-subtext">Last updated —</div>
      </div>
      <div class="chart-placeholder">
        <canvas id="temp-chart"></canvas>
      </div>
    </section>

  </div>
</main>

<script>
/* =======================
   CONFIG
======================= */
const API_BASE = "https://elysium-cloud.onrender.com";
const ENDPOINTS = {
  latest: `${API_BASE}/latest`,
  history: `${API_BASE}/history`
};

/* =======================
   TIME HELPERS (CST)
======================= */
function formatCST(iso) {
  return new Date(iso).toLocaleString("en-US", {
    timeZone: "America/Chicago",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    month: "numeric",
    day: "numeric"
  });
}

function secondsAgo(iso) {
  return Math.floor((Date.now() - new Date(iso)) / 1000);
}

function hourKeyCST(iso) {
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Chicago",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    hour12: false
  }).formatToParts(new Date(iso));

  const get = t => parts.find(p => p.type === t)?.value;
  return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}`;
}

/* =======================
   LANGUAGE TOGGLE
======================= */
let currentLang = "en";

const translations = {
  en: {
    title: "Elysium Tank",
    temp: "Temperature",
    unit: "°F",
    button: "日本語"
  },
  jp: {
    title: "天国水族館",
    temp: "水温",
    unit: "°F",
    button: "English"
  }
};

function applyLanguage() {
  const t = translations[currentLang];
  document.getElementById("title").textContent = t.title;
  document.getElementById("temp-label").textContent = t.temp;
  document.getElementById("temp-unit").textContent = t.unit;
  document.querySelector(".lang-toggle").textContent = t.button;
}

function toggleLanguage() {
  currentLang = currentLang === "en" ? "jp" : "en";
  applyLanguage();
}

/* =======================
   FETCH + UPDATE
======================= */
async function fetchLatest() {
  try {
    const r = await fetch(ENDPOINTS.latest, { cache: "no-store" });
    if (!r.ok) throw new Error(r.status);
    return await r.json();
  } catch (e) {
    console.error("fetchLatest failed", e);
    return {};
  }
}

async function updateDashboard() {
  const data = await fetchLatest();

  const temp = data.temperature_f ?? data.temp_f;
  if (temp != null) {
    document.getElementById("temp-value").textContent =
      Number(temp).toFixed(2);
  }

  if (data.timestamp) {
    const secs = secondsAgo(data.timestamp);
    document.getElementById("last-updated").textContent =
      `Last updated ${secs}s ago (${formatCST(data.timestamp)})`;
  }
}

/* =======================
   HISTORY → HOURLY AVG
======================= */
let tempChart;

async function fetchHistory() {
  const r = await fetch(ENDPOINTS.history);
  if (!r.ok) return [];
  return r.json();
}

async function updateChart() {
  const history = await fetchHistory();
  const cutoff = Date.now() - 24 * 60 * 60 * 1000;

  const buckets = new Map();

  for (const r of history) {
    const t = new Date(r.timestamp).getTime();
    if (t < cutoff) continue;

    const v = r.temperature_f ?? r.temp_f ?? r.value;
    if (!Number.isFinite(v)) continue;

    const key = hourKeyCST(r.timestamp);
    const cur = buckets.get(key) || { sum: 0, count: 0 };
    cur.sum += v;
    cur.count++;
    buckets.set(key, cur);
  }

  const keys = Array.from(buckets.keys()).sort();
  const labels = keys.map(k => `${k.slice(-2)}:00`);
  const data = keys.map(k => buckets.get(k).sum / buckets.get(k).count);

  const ctx = document.getElementById("temp-chart").getContext("2d");

  if (!tempChart) {
    tempChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data,
          borderColor: "rgba(255,106,193,0.95)",
          backgroundColor: "rgba(255,106,193,0.18)",
          fill: true,
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  } else {
    tempChart.data.labels = labels;
    tempChart.data.datasets[0].data = data;
    tempChart.update();
  }
}

/* =======================
   BOOT
======================= */
window.addEventListener("DOMContentLoaded", () => {
  applyLanguage();
  updateDashboard();
  updateChart();

  setInterval(updateDashboard, 5000);
  setInterval(updateChart, 60000);
});
</script>

</body>
</html>

