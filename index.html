<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elysium Tank Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
    <div id="title">Elysium Tank</div>
    <button class="lang-toggle" onclick="toggleLanguage()">日本語</button>
</header>

<main>
    <div class="sensor-grid">
        <!-- Temperature Panel -->
        <section class="sensor-panel">
            <div class="sensor-card">
                <div class="sensor-name" id="temp-label">Temperature</div>
                <div id="temp-value" class="sensor-value">--</div>
                <div class="sensor-unit" id="temp-unit">°F</div>
            </div>
            <div class="chart-placeholder">
                <canvas id="temp-chart"></canvas>
            </div>
        </section>

        <!-- Dissolved Oxygen Panel -->
        <section class="sensor-panel">
            <div class="sensor-card">
                <div class="sensor-name" id="do-label">Dissolved Oxygen</div>
                <div id="do-value" class="sensor-value">--</div>
                <div class="sensor-unit" id="do-unit">mg/L</div>
            </div>
            <div class="chart-placeholder">
                <canvas id="do-chart"></canvas>
            </div>
        </section>

        <!-- TDS Panel -->
        <section class="sensor-panel">
            <div class="sensor-card">
                <div class="sensor-name" id="tds-label">TDS / Conductivity</div>
                <div id="tds-value" class="sensor-value">--</div>
                <div class="sensor-unit" id="tds-unit">µS/cm</div>
            </div>
            <div class="chart-placeholder">
                <canvas id="tds-chart"></canvas>
            </div>
        </section>
    </div>
</main>

<script>
// =======================
// API CONFIGURATION
// =======================
const API_BASE = "https://elysium-cloud.onrender.com";
const ENDPOINTS = {
    latest: `${API_BASE}/latest`,
    history: `${API_BASE}/history`,
    health: `${API_BASE}/health`
};

// =======================
// LANGUAGE TOGGLE
// =======================
let currentLang = "en";

const translations = {
    en: {
        title: "Elysium Tank",
        temp: "Temperature",
        do: "Dissolved Oxygen",
        tds: "TDS / Conductivity",
        tempUnit: "°F",
        doUnit: "mg/L",
        tdsUnit: "µS/cm",
        button: "日本語"
    },
    jp: {
        title: "天国水族館",
        temp: "水温",
        do: "溶存酸素",
        tds: "TDS / 導電率",
        tempUnit: "°F",
        doUnit: "mg/L",
        tdsUnit: "µS/cm",
        button: "English"
    }
};

function applyLanguage() {
    const t = translations[currentLang];

    document.getElementById("title").textContent = t.title;

    document.getElementById("temp-label").textContent = t.temp;
    document.getElementById("temp-unit").textContent = t.tempUnit;

    document.getElementById("do-label").textContent = t.do;
    document.getElementById("do-unit").textContent = t.doUnit;

    document.getElementById("tds-label").textContent = t.tds;
    document.getElementById("tds-unit").textContent = t.tdsUnit;

    document.querySelector(".lang-toggle").textContent = t.button;
}

function toggleLanguage() {
    currentLang = currentLang === "en" ? "jp" : "en";
    applyLanguage();
}

applyLanguage();

// =======================
// LIVE VALUE UPDATE
// =======================
async function fetchLatest() {
    const res = await fetch(ENDPOINTS.latest);
    if (!res.ok) return {};
    return res.json();
}

async function updateDashboard() {
    try {
        const data = await fetchLatest();

        if (data.temperature_f !== undefined)
            document.getElementById("temp-value").textContent =
                data.temperature_f.toFixed(2);

        if (data.do_mg_per_l !== undefined)
            document.getElementById("do-value").textContent =
                data.do_mg_per_l.toFixed(2);

        if (data.tds_us_cm !== undefined)
            document.getElementById("tds-value").textContent =
                data.tds_us_cm.toFixed(1);

    } catch (err) {
        console.error("Update error (latest):", err);
    }
}

setInterval(updateDashboard, 5000);
updateDashboard();

// =======================
// HISTORY + CHARTS
// =======================
async function fetchHistory() {
    const res = await fetch(ENDPOINTS.history);
    if (!res.ok) return [];
    return res.json();
}

let tempChart, doChart, tdsChart;

function buildOrUpdateChart(chartRef, ctx, labels, data, colorLine, colorFill) {
    if (!ctx) return;

    if (!chartRef) {
        return new Chart(ctx, {
            type: "line",
            data: {
                labels,
                datasets: [
                    {
                        data,
                        borderColor: colorLine,
                        backgroundColor: colorFill,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: "#9ca3af",
                            maxTicksLimit: 5
                        },
                        grid: {
                            color: "rgba(148, 163, 184, 0.2)"
                        }
                    },
                    y: {
                        ticks: {
                            color: "#e5e7eb"
                        },
                        grid: {
                            color: "rgba(55, 65, 81, 0.5)"
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.parsed.y}`
                        }
                    }
                }
            }
        });
    } else {
        chartRef.data.labels = labels;
        chartRef.data.datasets[0].data = data;
        chartRef.update();
        return chartRef;
    }
}

async function updateCharts() {
    try {
        const history = await fetchHistory();
        if (!Array.isArray(history) || history.length === 0) return;

        const labels = history.map((r) => {
            try {
                return new Date(r.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit"
                });
            } catch {
                return "";
            }
        });

        // Allow for old structure: {value, timestamp} for temp
        const tempData = history.map((r) =>
            r.temperature_f !== undefined ? r.temperature_f :
            r.value !== undefined ? r.value : undefined
        );

        const doData = history.map((r) =>
            r.do_mg_per_l !== undefined ? r.do_mg_per_l : null
        );

        const tdsData = history.map((r) =>
            r.tds_us_cm !== undefined ? r.tds_us_cm : null
        );

        const tempCtx = document.getElementById("temp-chart")?.getContext("2d");
        const doCtx = document.getElementById("do-chart")?.getContext("2d");
        const tdsCtx = document.getElementById("tds-chart")?.getContext("2d");

        // Neon colors, semi-transparent fills
        tempChart = buildOrUpdateChart(
            tempChart,
            tempCtx,
            labels,
            tempData,
            "rgba(255, 106, 193, 0.95)",   // hot pink
            "rgba(255, 106, 193, 0.18)"
        );

        doChart = buildOrUpdateChart(
            doChart,
            doCtx,
            labels,
            doData,
            "rgba(77, 238, 234, 0.95)",    // cyan
            "rgba(77, 238, 234, 0.16)"
        );

        tdsChart = buildOrUpdateChart(
            tdsChart,
            tdsCtx,
            labels,
            tdsData,
            "rgba(139, 92, 246, 0.95)",    // purple
            "rgba(139, 92, 246, 0.18)"
        );

    } catch (err) {
        console.error("Update error (history):", err);
    }
}

// Initial chart load + periodic refresh
updateCharts();
setInterval(updateCharts, 30000); // every 30s

</script>

</body>
</html>

